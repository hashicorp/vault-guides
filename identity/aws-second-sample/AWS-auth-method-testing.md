# Configure and Test AWS Auth Method
You can enable and test Vault's AWS auth method following the steps below.  We show steps for both the Vault UI and Vault CLI, but some can only be done with the CLI.  Note that all the steps could have also been done with the Vault HTTP API using `curl` commands.

We will illustrate both the ec2 and iam methods.

## Create dev and qa secrets
We want to create some secrets for members of the dev and qa teams. You can do this with the Vault UI or CLI.

### Using the Vault UI
1. Login to the UI with a root token or other token that can create any secrets in the default K/V secrets engine.
2. Click on the "secret/" engine on the Secrets tab.
3. Click the "Create secret" button.
4. Enter the path dev/secrets.
5. Enter db_pwd key with any value.
6. Click the Add button and add server_pwd key with any value.
7. Click the Save button.
8. Repeat the above steps for the path qa/secrets.

### Using the Vault CLI
1. Run the command `vault write secret/dev/secrets db_pwd=fdsijljihf server_pwd=ohn78y87sds` using any passwords you want. You should see "Success! Data written to: secret/dev/secrets"
2. Run the command `vault write secret/qa/secrets db_pwd=d9892jssso3 server_pwd=2kdi39skosow2` using any passwords you want. You should see "Success! Data written to: secret/qa/secrets"

## Create dev and qa Policies
We want members of the dev and qa teams to be able to see secrets from their own team but not from the other team. We will create policies to accomplish this. This can be done with the Vault UI or CLI. The policies will give members of the teams full control (create, read, update, delete, list) over their team secrets and also ensure that they can access them in the Vault UI.

### Using the Vault UI
1. Login to the UI with a root token or other token that can create any policies.
2. Go to the Policies tab.
3. Click the "Create policy" button.
4. Enter "dev" as the policy name and paste the text from dev-policy.hcl into the policy field.
5. Click the "Create policy" button to save.
6. Click the Policies tab.
7. Click the "Create policy" button.
8. Enter "qa" as the policy name and paste the text from qa-policy.hcl into the policy field.
9. Click the "Create policy" button to save.

### Using the Vault CLI
You could use point a Vault client against your server after setting VAULT_ADDR and VAULT_TOKEN or just run the following commands on your Vault server after SSHing to it.
1. Copy the dev-policy.hcl and qa-policy.hcl files to your Vault server.
2. Run `env | grep VAULT` to make sure that you have VAULT_ADDR and VAULT_TOKEN environment variables set.
3. If they are not set, run `export VAULT_ADDR=http://127.0.0.1:8200` and `export VAULT_TOKEN=<your_root_token>`.
4. Run `vault policy write dev dev-policy.hcl` which should return "Success! Uploaded policy: dev".
5. Run `vault policy write qa qa-policy.hcl` which should return "Success! Uploaded policy: qa".

## Create Tokens
The developers and QA engineers will need Vault tokens or usernames in order to authenticate to Vault and create, write, and read their secrets. You will need to use the Vault CLI.
1. For each developer, run `vault token-create -display-name=<developer_name> -policy=dev`.
2. Deliver the token to the deveoper securely.
3. For each QA engineer, run `vault token-create -display-name=<qa_name> -policy=qa`.
4. Deliver the token to the QA engineer securely.

## Configure the AWS Auth Method Using the ec2 Method
We now want to configure the [AWS auth method](https://www.vaultproject.io/docs/auth/aws.html) on the Vault server. This method supports two ways that EC2 instances can authenticate themselves to Vault: ec2 and iam. In this section, we use the ec2 method.  We will use the iam method in the next section.

The ec2 method uses the EC2 Metadata Service which enables each instance to fetch its unique AWS Instance Identity Document using its PKCS#7 signature. We will associate role tags generated by Vault with the EC2 instances we create so that these instances are associated with the dev or qa policies we created above.

You could use point a Vault client against your server after setting VAULT_ADDR and VAULT_TOKEN or just run the following commands on your Vault server after SSHing to it.
1. Enable the AWS auth method by running `vault auth enable aws` which should show "Success! Enabled aws auth method at: aws/".
2. Configure the AWS auth method by running `vault write auth/aws/config/client access_key=<access_key> secret_key=<secret_key>`, replacing \<access_key\> and \<secret_key\> with AWS keys that have the permissions described in the [recommended Vault IAM policy](https://www.vaultproject.io/docs/auth/aws.html#recommended-vault-iam-policy). If you are running your Vault server on an EC2 instance and would rather rely upon the instance's EC2 instance role credentials instead of specifying permanent AWS keys, you can leave out this command. You should see "Success! Data written to: auth/aws/config/client".
3. Create a dev role by running `vault write auth/aws/role/dev-role auth_type=ec2 bound_account_id=<your_aws_account_id> role_tag=dev_role policies=default,dev max_ttl=24h` replacing \<your_aws_account_id\> with your AWS account ID. This command should return "Success! Data written to: auth/aws/role/dev-role".
4. Create the dev_role role tag by running `vault write auth/aws/role/dev-role/tag policies=dev max_ttl=24h` which will return a tag_key set to "dev_role" and a tag_value which you will need to save so you can add a suitable tag to EC2 instances in the dev role, using the value of the tag_key as the tag's key and the value of the tag_value as the tag's value. The value of tag_value will be something like "v1:rNIvI16ueCo=:r=dev-".
5. Create a qa role by running `vault write auth/aws/role/qa-role auth_type=ec2 bound_account_id=<your_aws_account_id> role_tag=qa_role policies=default,qa max_ttl=24h` replacing \<your_aws_account_id\> with your AWS account ID. This command should return "Success! Data written to: auth/aws/role/qa-role".
6. Create the qa_role role tag by running `vault write auth/aws/role/qa-role/tag policies=qa max_ttl=24h` which will return a tag_key set to "qa_role" and a tag_value which you will need to save so you can add a suitable tag to EC2 instances in the qa role, using the value of the tag_key as the tag's key and the value of the tag_value as the tag's value. The value of tag_value will be something like "v1:ku7Xfw9oQv0=:r=qa-".

## Create EC2 instances with the dev and qa roles
You can create EC2 instances with the dev and qa roles however you want, including using Terraform or the AWS Console. While or after creating them, you need to assign instances in the dev and qa roles with the dev_role and qa_role tags respectively. When doing this, set the tag's key to "dev_role" or "qa_role" and set the tag's value to the value of tag_value that was returned when you created the dev_role or qa_role role tag in the previous section, depending on whether you you want the EC2 instance to have the dev or qa roles.. If you did not do this when creating them, you can easily add them in the AWS Console. Just find the instance, select it, select the Tags tab in the bottom portion of the window, click the "Add/Edit Tags" button, click the "Create Tag" button, add the correct tag, and then click the Save button.

## Authenticating with a Dev Instance
Follow these steps to authenticate against Vault with an EC2 instance in the dev role and read the dev secrets you created above.
1. Connect to your instance with SSH. If you are not sure how, select your instance in the AWS Console and click the Connect button. You should run the command shown from a directory containing your SSH key or provide a path to the key.
2. Install the Vault binary by running these commands:
```
curl -L "https://releases.hashicorp.com/vault/0.9.5/vault_0.9.5_linux_amd64.zip" > vault.zip
unzip vault
```
3. Move vault to a location in your path such as /usr/local/bin with a command like `sudo mv vault /usr/local/bin/vault`.
4. Export your Vault server's address with `export VAULT_ADDR=<vault_server>:8200`.
5. Determine your instance's pkcs#7 certificate by running `curl -s http://169.254.169.254/latest/dynamic/instance-identity/pkcs7 | tr -d '\n'` on the instance. You will get a long multi-line response containing the certificate.
6. You can now use that certificate to authenticate to Vault with the command `vault write auth/aws/login role=dev-role pkcs7=<your_cert>`, replacing \<your_cert\> with the certificate you just obtained.
7. If the authentication is successful, you will receive a Vault token and information about it. Otherwise, you will receive an error. You should then make sure that you added the role tag to your instance and followed all of the above steps correctly.
8. In order to use the Vault CLI and read dev secrets, you need to export the Vault token you got back when you authenticated. Run `export VAULT_TOKEN=<token>`, using your token.
9. Now, you should be able to read secrets from the secret/dev path with `vault read secret/dev/secrets` which should return the dev versions of the db_pwd and server_pwd keys.
10. Finally, confirm that this instance cannot read secrets from the secret/qa path by running `vault read secret/qa/secrets` which should give an HTTP 403 error with message "permission denied".

## Authenticating with a QA Instance
Follow these steps to authenticate against Vault with an EC2 instance in the qa role and read the qa secrets you created above.
1. Connect to your instance with SSH. If you are not sure how, select your instance in the AWS Console and click the Connect button. You should run the command shown from a directory containing your SSH key or provide a path to the key.
2. Install the Vault binary by running these commands:
```
curl -L "https://releases.hashicorp.com/vault/0.9.5/vault_0.9.5_linux_amd64.zip" > vault.zip
unzip vault
```
3. Move vault to a location in your path such as /usr/local/bin with a command like `sudo mv vault /usr/local/bin/vault`.
4. Export your Vault server's address with `export VAULT_ADDR=<vault_server>:8200`.
5. Determine your instance's pkcs#7 certificate by running `curl -s http://169.254.169.254/latest/dynamic/instance-identity/pkcs7 | tr -d '\n'` on the instance. You will get a long multi-line response containing the certificate.
6. You can now use that certificate to authenticate to Vault with the command `vault write auth/aws/login role=qa-role pkcs7=<your_cert>`, replacing \<your_cert\> with the certificate you just obtained.
7. If the authentication is successful, you will receive a Vault token and information about it. Otherwise, you will receive an error. You should then make sure that you added the role tag to your instance and followed all of the above steps correctly.
8. In order to use the Vault CLI and read qa secrets, you need to export the Vault token you got back when you authenticated. Run `export VAULT_TOKEN=<token>`, using your token.
9. Now, you should be able to read secrets from the secret/qa path with `vault read secret/qa/secrets` which should return the qa versions of the db_pwd and server_pwd keys.
10. Finally, confirm that this instance cannot read secrets from the secret/dev path by running `vault read secret/dev/secrets` which should give an HTTP 403 error with message "permission denied".

## Configure the AWS Auth Method Using the iam Method
We will now illustrate how to use the iam method, by providing two examples.  The first can be used within a single account, while the third can span 2 accounts.

Before setting these examples up, please associate the policy below with the role your Vault server runs under and the roles that your EC2 instances that you want to authenticate run under.

vault-aws-authentication policy
```
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ec2:DescribeInstances",
        "iam:GetInstanceProfile",
        "iam:GetUser",
        "iam:GetRole"
      ],
      "Resource": "*"
    }
  ]
}
```

Also do `export VAULT_ADDR=<vault_url>` including the port.  So something like http://<IP>:8200

And install the vault binary on your EC2 instance as described above.

### Example 1:
The first example essentially does same as ec2 method since it infers EC2 instance's identity and uses its role in order to limit authentication to EC2 intances in the specified account. Note that all calls except the logins are done on the Vault server using a privileged token.

```
vault auth enable aws

vault write auth/aws/role/dev-role auth_type=iam bound_account_id=<account_id> inferred_entity_type=ec2_instance inferred_aws_region=us-east-1 policies=dev max_ttl=24h

vault login -method=aws role=dev-role
```
If you want, you can add an extra command to require a special header on the login calls which would then have to include that header set to the right value. You could use a different domain for the iam_server_id_header_value and header_value, but they should match each other.

```
vault write auth/aws/config/client iam_server_id_header_value=vault.example.com

vault login -method=aws header_value=vault.example.com role=dev-role
```

The final command should give you output like:

Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                                Value
---                                -----
token                              b19de968-a73c-54f8-a513-a1d4b15bdb48
token_accessor                     30b2fd84-73c1-6eef-8f96-bc99791cc2ae
token_duration                     768h
token_renewable                    true
token_policies                     [default dev]
token_meta_inferred_entity_type    ec2_instance
token_meta_account_id              362381645759
token_meta_auth_type               iam
token_meta_canonical_arn           arn:aws:iam::362381645759:role/roger20180321221209238500000001
token_meta_client_arn              arn:aws:sts::362381645759:assumed-role/roger20180321221209238500000001/i-07b2ff4cc60049f47
token_meta_client_user_id          AROAIBMRMFI4BY3T4TSIW
token_meta_inferred_aws_region     us-east-1
token_meta_inferred_entity_id      i-07b2ff4cc60049f47

### Example 2:
Our second example restricts authentication to IAM roles in a particular account.

First, create two IAM roles, chef-dev and chef-qa.  Assign the vault-aws-authentication policy shown above to both roles.  That way, instances that have them will be able to authenticate against Vault. Other than that, the roles just serve as tags on the instances so that dev and qa instances will end up with the right Vault roles and only be able to read dev and qa secrets respectively.

Here are the commands you should run on the Vault server for this example:

```
# Enable the AWS auth method
vault auth enable aws

# Define the dev-role
vault write auth/aws/role/dev-role auth_type=iam bound_iam_principal_arn=arn:aws:iam::362381645759:role/chef-dev  policies=dev max_ttl=24h

# Define the qa-role
vault write auth/aws/role/qa-role auth_type=iam bound_iam_principal_arn=arn:aws:iam::362381645759:role/chef-qa  policies=qa max_ttl=24h

```

You can authenticate from a dev instance to Vault with:
`vault login -method=aws role=dev-role`

This should give you output like:

Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                                Value
---                                -----
token                              40c104f5-081f-4d02-8941-08d1a4b6ede7
token_accessor                     6ad0daa4-e8f5-062d-ed93-3ff126f9290c
token_duration                     768h
token_renewable                    true
token_policies                     [default dev]
token_meta_inferred_aws_region     n/a
token_meta_inferred_entity_id      n/a
token_meta_inferred_entity_type    n/a
token_meta_account_id              362381645759
token_meta_auth_type               iam
token_meta_canonical_arn           arn:aws:iam::362381645759:role/chef-dev
token_meta_client_arn              arn:aws:sts::362381645759:assumed-role/chef-dev/i-0e4653e40480d31ac
token_meta_client_user_id          AROAJTX274TFBJ6ZFA3YC


You can authenticate from a qa instance with:
`vault login -method=aws role=qa-role`

This should give you output like:

Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run "vault login"
again. Future Vault requests will automatically use this token.

Key                                Value
---                                -----
token                              395db08a-6b47-e6cf-d0b4-2b1e4daf4fd5
token_accessor                     ca210b40-745e-9804-c25f-f21392f2e3dc
token_duration                     768h
token_renewable                    true
token_policies                     [default qa]
token_meta_inferred_aws_region     n/a
token_meta_inferred_entity_id      n/a
token_meta_inferred_entity_type    n/a
token_meta_account_id              362381645759
token_meta_auth_type               iam
token_meta_canonical_arn           arn:aws:iam::362381645759:role/chef-qa
token_meta_client_arn              arn:aws:sts::362381645759:assumed-role/chef-qa/i-01ab34829fee925fd
token_meta_client_user_id          AROAI3IU6W6FQ6EVG3F72


Note that the rows could end up in a different order.

## Example 3: Cross Account Access:

Do the following to support access from a different account:

```
vault auth enable aws

vault write auth/aws/role/dev-role auth_type=iam bound_account_id=190840704773 inferred_entity_type=ec2_instance inferred_aws_region=us-east-1 policies=dev max_ttl=24h

vault write auth/aws/config/sts/190840704773 sts_role=arn:aws:iam::190840704773:role/VaultAccess

```

You also have to modify the policy on the Vault server (but not the EC2 node being authenticated) to be:

```
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "ec2:DescribeInstances",
                "iam:GetInstanceProfile",
                "iam:GetUser",
                "iam:GetRole"
            ],
            "Resource": "*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "sts:AssumeRole"
            ],
            "Resource": [
                "arn:aws:iam::190840704773:role/VaultAccess"
            ]
        }
    ]
}
```
However, the Vault account has to be added to the VaultAccess role as a Trusted Entity.  For instance, add "AWS": "arn:aws:iam::362381645759:root" to the Trust Relationship of the VaultAccess role in the other account.

You can authenticate from a dev instance with:
`vault login -method=aws role=dev-role`

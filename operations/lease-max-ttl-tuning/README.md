# Generating dynamic MySQL credentials using Vault Database backend

Every token generated by Vault has an associated TTL (time to live). Tokens need to be refreshed prior to this expiration time, otherwise Vault will not accept requests using an expired token until it is refreshed.
The maximum time allowed for a token to be refreshed is defined by the max_ttl attribute. Once this value is reached, the token expires and can no longer be refreshed, a new token must be issued.

In this guide we will show how token max_ttl can be set at the system level, at the mount level and at configuration level. In summary the configuration level max_ttl can't be greater than either the system or the mount max_ttl. Additionaly, the system max_ttl sets the treshold for all max_ttl's in a Vault. A complete description can be found [here](https://www.vaultproject.io/docs/concepts/tokens.html#the-general-case)

_Note: Exceptions to the above:_

_- *Root tokens*: TTL does not expire and not bound by max_ttl_

_- *Periodic tokens*: Meant for long running services, such as Jenkins. You will set a "period", which is essentially the TTL that the token needs to be refreshed - however periodic tokens are not impacted by any max_ttl, they can be refreshed until revoked._

## Reference Material
Complete documentation of the Vault tokens and leases can be found here:
https://www.vaultproject.io/docs/concepts/tokens.html

## Estimated Time to Complete
5 minutes

## Personas
Vault admin

## Challenge
A Vault admin may want to set a max_ttl for a configuration that is greater than the default max_ttl of the mount, which defaults to 32 days. They will be able to set this, however when Vault generates the lease, it will have the default max_ttl. This behavior might seem baffling at first, however it follows the rule that the system and the mount max _ttl take precedence over the config max_ttl.

## Solution
This demo code shows how the max_ttl of the mount can constrain the ttl and the max_ttl of the config. The same happens when the system max_ttl is changed.

For this example we will use the ttl associated with database secrets engine.

## Prerequisites
The sample code in this repository is self-contained, only requiring Vagrant and a virtual machine provider to be installed in the machine. More information at: https://www.vagrantup.com/downloads.html

## Steps
The bellow steps should be executed in a terminal once this repository is cloned

### Step 1: Run virtual machine
```
# This will install and run Vault in dev mode
cd operations/lease-max-tll-tuning
vagrant up
```

### Step 2: Install MySQL and configure Vault
```
# Connect to the virtual machine
vagrant ssh

# Configure environment vars
export VAULT_ADDR=http://0.0.0.0:8200
export VAULT_TOKEN=password

# This will install, run and configure MySQL, and configure Vault to use the dynamic database credentials functionality
cd /vagrant
./install-database.sh

# Mount database backend
vault mount database

# Configure MySQL connection
vault write database/config/mysql \
    plugin_name=mysql-legacy-database-plugin \
    connection_url="vaultadmin:vaultadminpassword@tcp(127.0.0.1:3306)/" \
    allowed_roles="readonly"

# Create MySQL readonly role
vault write database/roles/readonly \
    db_name=mysql \
    creation_statements="CREATE USER '{{name}}'@'%' IDENTIFIED BY '{{password}}';GRANT SELECT ON *.* TO '{{name}}'@'%';" \
    default_ttl="30m" \ #<------------------------------------------------------------ #Note this value!!!
    max_ttl="24h" #<------------------------------------------------------------ #Note this value!!!
```
### Step 3: Read credentials and validate TTL
```
vault read database/creds/readonly

# Output:
Key            	Value
---            	-----
lease_id       	database/creds/readonly/afc69c10-561f-e17f-6a38-017e1068ba85
lease_duration 	30m0s #<------------------------------------------------------------ #Note this value!!!
lease_renewable	true
password       	A1a-rsrpx2s9ssr179r9
username       	v-read-25vtuw15s
```
### Step 4: Verify and update mount max_lease_ttl:
```
vault read sys/mounts/database/tune

# Output:
Key              	Value
---              	-----
default_lease_ttl	2764800
force_no_cache   	false
max_lease_ttl    	2764800 #<------------------------------------------------------------ #Note this value!!!

# Update mount max_ttl
vault write sys/mounts/database/tune max_lease_ttl=30

# Check value:
vault read sys/mounts/database/tune

# Output:
Key              	Value
---              	-----
default_lease_ttl	2764800
force_no_cache   	false
max_lease_ttl    	30 #<------------------------------------------------------------ #Note this value!!!
```
### Step 5: Read DB credentials and verify TTL
```
vault read database/creds/readonly

# Output - see how now the lease duration is 30s, constrained by the new mount max_ttl.
# Remember, the leases inside a mount cant be greater than either the mount or the system default.
Key            	Value
---            	-----
lease_id       	database/creds/readonly/8ed12999-381e-4dac-3288-6840eeaf4f06
lease_duration 	30s #<------------------------------------------------------------ #Note this value!!!
lease_renewable	true
password       	A1a-q6w01tyu72uz51v1
username       	v-read-38u5wv14u

```
### Step 6: Restore mount max_lease_ttl to default 32 days (2764800 seconds):
```
vault write sys/mounts/database/tune max_lease_ttl=2764800

# To check:
vault read sys/mounts/database/tune

# Output
Key              	Value
---              	-----
default_lease_ttl	2764800
force_no_cache   	false
max_lease_ttl    	2764800 #<------------------------------------------------------------ #Note this value!!!
_________________________________________
```
### Step 7: Read DB credentials again and verify TTL
```
vault read database/creds/readonly

# Output - see how now the lease duration is 30s, constrained by the new mount max_ttl.
# Remember, the leases inside a mount cant be greater than either the mount or the system default.
Key            	Value
---            	-----
lease_id       	database/creds/readonly/8ed12999-381e-4dac-3288-6840eeaf4f06
lease_duration 	30m #<------------------------------------------------------------ #Note this value!!!
lease_renewable	true
password       	Fkf-aqe01dyf7edz5fhj
username       	v-read-hjuhjveyf
```
### Step 8: Change system max_lease_ttl:
```
# Now let's change the system max_ttl, which is done in the Vault configuration file.
# In order to do that, we need to first stop the process running vault:
 ps aux | grep vault
# Output:
root      5266  0.0  4.8  62364 24224 ?        Sl   13:43   0:00 /usr/local/bin/vault server -dev -dev-root-token-id=password -dev-listen-address=0.0.0.0:8200
# Now we kill the process:
sudo kill -9 5266

# Now edit your Vault config, reference for possible values here: https://www.vaultproject.io/docs/configuration/index.html.
# For example:
-------------------------------------------
vault.hcl:
		storage "file" {
		  path = "/home/vagrant/data"
		}

		listener "tcp" {
		  address     = "0.0.0.0:8200"
		  tls_disable = 1
		}

		max_lease_ttl = "30s"
		# cannot have DefaultLeaseTTL larger than MaxLeaseTTL
		default_lease_ttl="30s"

		ui = true
--------------------------------------------
# Start Vault normally:
vault server -config=vault.hcl &
vault init
vault unseal <UNSEAL-KEY-HERE>
export VAULT_TOKEN=<ROOT-TOKEN-HERE>
```
### Step 9: Check mount max_lease_ttl:
```
vault read sys/mounts/database/tune

# Output
Key              	Value
---              	-----
default_lease_ttl	30
force_no_cache   	false
max_lease_ttl    	30 #<------------------------------------------------------------ #Note this value!!!
```
### Step 10: Generate db credential and validate max_lease_ttl:
```
# And if we generate a credential:
vault read database/creds/readonly

# Output
Key            	Value
---            	-----
lease_id       	database/creds/readonly/9904bbd2-d27d-cba5-bdc0-95708daea880
lease_duration 	30s #<------------------------------------------------------------ #Note this value!!!
lease_renewable	true
password       	A1a-ss1z6s92v168qrv9
username       	v-read-88rqxx3p0

# Even though in the configuration we have 30 mins.
vault read database/roles/readonly

# Output
Key                  	Value
---                  	-----
creation_statements  	CREATE USER '{{name}}'@'%' IDENTIFIED BY '{{password}}';GRANT SELECT ON *.* TO '{{name}}'@'%';
db_name              	mysql
default_ttl          	1800 #1800 seconds = 30 mins
max_ttl              	86400 #<------------------------------------------------------------ #Note this value!!!
renew_statements
revocation_statements
rollback_statements

# This shows that the system max_ttl and the mount max_ttl set the maximum boundary of a configuration.
```

## Additional References:
A complete guide for token (including periodic tokens) can be found here:
https://learn.hashicorp.com/vault/identity-access-management/tokens
